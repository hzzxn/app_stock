<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Estadísticas de Ventas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="{{ url_for('static', filename='css/styles.css', v='4') }}" rel="stylesheet">
  <style>
    /* Colores semánticos para las tarjetas de estadísticas */
    .stat-card { border-radius: 12px; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); }
    
    .stat-card.cobrado { border-left: 4px solid #28a745; }
    .stat-card.cobrado .stat-value { color: #28a745 !important; }
    .stat-card.cobrado .stat-icon { color: #28a745; }
    
    .stat-card.pendiente { border-left: 4px solid #ffc107; }
    .stat-card.pendiente .stat-value { color: #ffc107 !important; }
    .stat-card.pendiente .stat-icon { color: #ffc107; }
    
    .stat-card.ingreso { border-left: 4px solid #0d6efd; }
    .stat-card.ingreso .stat-value { color: #0d6efd !important; }
    .stat-card.ingreso .stat-icon { color: #0d6efd; }
    
    .stat-card.ganancia { border-left: 4px solid var(--orange, #fd7e14); }
    .stat-card.ganancia .stat-value { color: var(--orange, #fd7e14) !important; }
    .stat-card.ganancia .stat-icon { color: var(--orange, #fd7e14); }
    
    .stat-card.promedio { border-left: 4px solid #6c757d; }
    .stat-card.promedio .stat-value { color: #6c757d !important; }
    .stat-card.promedio .stat-icon { color: #6c757d; }
    
    .stat-icon { font-size: 1.5rem; opacity: 0.8; }
    .stat-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 500; }
    .stat-value { font-size: 1.6rem; font-weight: 700; margin: 0; }
    .stat-detail { font-size: 13px; color: var(--text-secondary); margin-top: 4px; font-weight: 500; }
    
    /* Fila de totales en tablas */
    .row-total { background: rgba(253, 126, 20, 0.1); font-weight: 700; }
    .row-total td { border-top: 2px solid var(--orange, #fd7e14) !important; }
  </style>
</head>
<body class="{{ user_theme }}">

<!-- ═══════════════════════════════════════════════════════════════════════════
     MOBILE NAVBAR
═══════════════════════════════════════════════════════════════════════════ -->
<nav class="mobile-navbar hide-desktop">
  <a href="{{ url_for('dashboard') }}" class="hamburger-btn" aria-label="Volver">
    <i class="bi bi-arrow-left"></i>
  </a>
  <div class="navbar-brand">
    <div class="brand-logo brand-logo--mobile">
      <img src="{{ url_for('static', filename='branding/logo_icon.png') }}" alt="China Import" 
           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
      <div class="brand-logo-fallback brand-logo-fallback--icon" style="display:none;">
        <i class="bi bi-bar-chart"></i>
      </div>
    </div>
    <span>Estadísticas</span>
  </div>
  <div style="width:44px;"></div>
</nav>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 style="margin-bottom: 4px;"><i class="bi bi-bar-chart me-2"></i>Estadísticas de Ventas</h3>
      <small class="text-muted">Resumen financiero del negocio</small>
    </div>
    <div>
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Volver</a>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       TARJETAS PRINCIPALES - Estado financiero del negocio
  ═══════════════════════════════════════════════════════════════════════════ -->
  <div class="row g-3 mb-4">
    <!-- Pagos recibidos (verde) - Dinero ya cobrado -->
    <div class="col-6 col-lg">
      <div class="card p-3 stat-card cobrado">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="stat-label"><i class="bi bi-cash-stack me-1"></i>Pagos recibidos</div>
            <h4 class="stat-value">S/ {{ '%.2f'|format(stats.pagos_recibidos) }}</h4>
            <div class="stat-detail">{{ stats.ventas_pagadas }} ventas cobradas</div>
          </div>
          <span class="stat-icon"><i class="bi bi-check-circle"></i></span>
        </div>
      </div>
    </div>
    
    <!-- Monto pendiente (amarillo) - Dinero por cobrar -->
    <div class="col-6 col-lg">
      <div class="card p-3 stat-card pendiente">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="stat-label"><i class="bi bi-hourglass-split me-1"></i>Monto pendiente</div>
            <h4 class="stat-value">S/ {{ '%.2f'|format(stats.monto_pendiente) }}</h4>
            <div class="stat-detail">{{ stats.ventas_pendientes }} ventas por cobrar</div>
          </div>
          <span class="stat-icon"><i class="bi bi-clock"></i></span>
        </div>
      </div>
    </div>
    
    <!-- Ingreso total (azul) - Todas las ventas -->
    <div class="col-6 col-lg">
      <div class="card p-3 stat-card ingreso">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="stat-label"><i class="bi bi-graph-up-arrow me-1"></i>Ingreso total</div>
            <h4 class="stat-value">S/ {{ '%.2f'|format(stats.total_revenue) }}</h4>
            <div class="stat-detail">{{ stats.total_sales }} ventas totales</div>
          </div>
          <span class="stat-icon"><i class="bi bi-currency-dollar"></i></span>
        </div>
      </div>
    </div>
    
    <!-- Ganancia total (naranja) -->
    <div class="col-6 col-lg">
      <div class="card p-3 stat-card ganancia">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="stat-label"><i class="bi bi-trophy me-1"></i>Ganancia total</div>
            <h4 class="stat-value">S/ {{ '%.2f'|format(stats.total_profit) }}</h4>
            <div class="stat-detail">Ingresos menos costos</div>
          </div>
          <span class="stat-icon"><i class="bi bi-star"></i></span>
        </div>
      </div>
    </div>
    
    <!-- Ticket promedio (gris) -->
    <div class="col-6 col-lg">
      <div class="card p-3 stat-card promedio">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="stat-label"><i class="bi bi-receipt me-1"></i>Ticket promedio</div>
            <h4 class="stat-value">S/ {{ '%.2f'|format(stats.avg_ticket) }}</h4>
            <div class="stat-detail">Por venta</div>
          </div>
          <span class="stat-icon"><i class="bi bi-calculator"></i></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       TOP PRODUCTOS
  ═══════════════════════════════════════════════════════════════════════════ -->
  <div class="row">
    <div class="col-md-6 mb-3">
      <div class="card p-3">
        <h5><i class="bi bi-fire me-2"></i>Top productos por cantidad</h5>
        <p class="text-muted small mb-2">Los productos más vendidos</p>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr><th>Producto</th><th>SKU</th><th class="text-end">Cantidad</th></tr>
            </thead>
            <tbody>
              {% for p in stats.top_by_qty %}
              <tr>
                <td>{{ p.nombre or '—' }}</td>
                <td class="text-muted">{{ p.sku or '—' }}</td>
                <td class="text-end"><strong>{{ p.qty }}</strong></td>
              </tr>
              {% endfor %}
              {% if stats.top_by_qty|length == 0 %}
              <tr><td colspan="3" class="text-center text-muted">Sin datos</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="card p-3">
        <h5><i class="bi bi-cash-coin me-2"></i>Top productos por ganancia</h5>
        <p class="text-muted small mb-2">Los productos más rentables</p>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr><th>Producto</th><th>SKU</th><th class="text-end">Ganancia</th></tr>
            </thead>
            <tbody>
              {% for p in stats.top_by_profit %}
              <tr>
                <td>{{ p.nombre or '—' }}</td>
                <td class="text-muted">{{ p.sku or '—' }}</td>
                <td class="text-end" style="color: var(--orange);"><strong>S/ {{ '%.2f'|format(p.profit) }}</strong></td>
              </tr>
              {% endfor %}
              {% if stats.top_by_profit|length == 0 %}
              <tr><td colspan="3" class="text-center text-muted">Sin datos</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       AGRUPACIONES TEMPORALES
  ═══════════════════════════════════════════════════════════════════════════ -->
  <div class="row">
    <div class="col-md-6 mb-3">
      <div class="card p-3">
        <h5><i class="bi bi-calendar-day me-2"></i>Agrupado por día</h5>
        <div class="table-responsive" style="max-height:320px;overflow:auto;">
          <table class="table table-sm mb-0">
            <thead><tr><th>Fecha</th><th class="text-end">Ventas</th><th class="text-end">Ingreso</th><th class="text-end">Ganancia</th></tr></thead>
            <tbody>
              {% for d in stats.by_day %}
              <tr>
                <td>{{ d.date }}</td>
                <td class="text-end">{{ d.sales }}</td>
                <td class="text-end">S/ {{ '%.2f'|format(d.revenue) }}</td>
                <td class="text-end">S/ {{ '%.2f'|format(d.profit) }}</td>
              </tr>
              {% endfor %}
              {% if stats.by_day|length == 0 %}
              <tr><td colspan="4" class="text-center text-muted">Sin datos</td></tr>
              {% else %}
              <!-- Fila TOTAL -->
              <tr class="row-total">
                <td><strong>TOTAL</strong></td>
                <td class="text-end"><strong>{{ stats.total_day_sales }}</strong></td>
                <td class="text-end"><strong>S/ {{ '%.2f'|format(stats.total_day_revenue) }}</strong></td>
                <td class="text-end"><strong>S/ {{ '%.2f'|format(stats.total_day_profit) }}</strong></td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="card p-3">
        <h5><i class="bi bi-calendar-month me-2"></i>Agrupado por mes</h5>
        <div class="table-responsive" style="max-height:320px;overflow:auto;">
          <table class="table table-sm mb-0">
            <thead><tr><th>Mes</th><th class="text-end">Ventas</th><th class="text-end">Ingreso</th><th class="text-end">Ganancia</th></tr></thead>
            <tbody>
              {% for m in stats.by_month %}
              <tr>
                <td>{{ m.month }}</td>
                <td class="text-end">{{ m.sales }}</td>
                <td class="text-end">S/ {{ '%.2f'|format(m.revenue) }}</td>
                <td class="text-end">S/ {{ '%.2f'|format(m.profit) }}</td>
              </tr>
              {% endfor %}
              {% if stats.by_month|length == 0 %}
              <tr><td colspan="4" class="text-center text-muted">Sin datos</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
