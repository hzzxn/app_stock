<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Boleta {{ sale['receipt'] }}</title>
  <!-- Bootstrap Icons for screen UI (hidden when printing) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" media="screen">
  <style>
    /* Thermal ticket styles - 80mm width */
    :root{ --text:#000; --muted:#555; --separator:#000 }
    html,body{margin:0;padding:0;background:#fff;color:var(--text);font-family:monospace, 'Courier New', monospace}
    .ticket{width:80mm;max-width:80mm;padding:6mm 6mm 8mm 6mm;margin:0 auto}
    .center{text-align:center}
    .logo{display:block;margin:0 auto 6px auto;max-width:64mm;height:auto}
    h1{font-size:14px;margin:2px 0;font-weight:700}
    h2{font-size:12px;margin:2px 0;font-weight:700}
    p{margin:2px 0;font-size:11px}
    .muted{color:var(--muted);font-size:10px}
    .sep{border-top:1px dashed var(--separator);margin:6px 0}

    table{width:100%;border-collapse:collapse;font-size:11px}
    th,td{padding:2px 0;text-align:left}
    .qty{width:36px;text-align:right}
    .total-col{text-align:right}

    .total-amount{font-weight:700;font-size:13px;margin-top:6px;text-align:right}
    .footer{margin-top:8px;text-align:center;font-size:10px}

    /* Controls not printed */
    .no-print{display:block;margin-top:8px;text-align:center}

    /* Print settings for thermal printer */
    @media print{
      body,html{background:#fff}
      /* Hide any interactive UI when printing - strong rules to override inline/bootstrap */
      .no-print{display:none !important; visibility:hidden !important; height:0 !important; overflow:hidden !important}
      @page{size:80mm auto;margin:0}
      .ticket{padding:4mm}
    }
  </style>
</head>
<body>
  <div class="ticket">
    <!-- Logo centered -->
    <img class="logo" src="{{ url_for('static', filename='branding/logo_full.png') }}" alt="China Import"
         onerror="this.style.display='none';">

    <div class="center">
      <h1>China Import</h1>
      <p class="muted">Galpón Puno</p>
      <p class="muted">Tel: +51 955 069 470</p>
      <p class="muted">RUC: 10454992526</p>
    </div>

    <div class="sep"></div>

    <div>
      <p><strong>BOLETA INTERNA</strong></p>
      <p>Recibo: <strong>{{ sale['receipt'] }}</strong></p>
      <p class="muted">Fecha (UTC): {{ sale['ts'] }}</p>
      <p class="muted">Usuario: {{ sale['user'] }}</p>
    </div>

    <div class="sep"></div>

    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th class="qty">Cant</th>
          <th class="total-col">Total</th>
        </tr>
      </thead>
      <tbody>
          {% for it in sale['items'] %}
          {% set uv = it.unit or 'UNIDAD' %}
          {% set uv_label = it.unit_label %}
          {% set uv_display = uv_label if (uv == 'OTRA' and uv_label) else uv %}
          <tr>
            <td>
              {{ it.nombre }}
              {% if it.variant_attributes and it.variant_attributes|length > 0 %}
                <br><span class="muted" style="font-size:9px">
                  {% for k, v in it.variant_attributes.items() %}
                    {{ k }}: {{ v }}{% if not loop.last %}, {% endif %}
                  {% endfor %}
                  {% if uv != 'UNIDAD' %} | {{ uv_display }}{% endif %}
                </span>
              {% elif it.variant_id %}
                <br><span class="muted" style="font-size:9px">{{ it.variant_id }}{% if uv != 'UNIDAD' %} | {{ uv_display }}{% endif %}</span>
              {% endif %}
            </td>
            <td class="qty">{{ it.qty }}{% if uv != 'UNIDAD' %}<br><span class="muted" style="font-size:8px">{{ uv_display }}</span>{% endif %}</td>
            <td class="total-col">S/ {{ '%.2f'|format(it.line_total) }}</td>
          </tr>
          {% endfor %}
        </tbody>
    </table>

    <div class="sep"></div>

    <div class="total-amount">TOTAL: S/ {{ '%.2f'|format(sale['total']) }}</div>
    <div class="no-print" style="display:flex;justify-content:space-between;margin-top:4px">
      <div class="muted">Pagado:</div>
      <div class="muted">S/ {{ '%.2f'|format(sale.get('paid_amount') if sale.get('paid_amount') is not none else 0.0) }}</div>
    </div>
    <div class="no-print" style="display:flex;justify-content:space-between;margin-top:2px">
      <div class="muted">Pendiente:</div>
      <div class="muted">S/ {{ '%.2f'|format(sale.get('pending_amount') if sale.get('pending_amount') is not none else sale.get('total')) }}</div>
    </div>
    <div class="muted" style="text-align:right;font-size:10px;margin-top:4px">Precio incluye IGV</div>

    <div class="footer muted">Boleta interna – no válida para SUNAT</div>
    <div class="no-print" style="margin-top:8px">
      {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for cat, msg in messages %}
              {% set cls = 'secondary' %}
              {% if cat == 'success' %}{% set cls = 'success' %}{% elif cat == 'danger' %}{% set cls = 'danger' %}{% elif cat == 'warning' %}{% set cls = 'warning' %}{% endif %}
              <div class="alert alert-{{ cls }} py-1 px-2 mb-2" role="alert" style="font-size:0.9rem; margin:0;">{{ msg }}</div>
            {% endfor %}
          {% endif %}
      {% endwith %}
      <div style="margin-bottom:6px">
        <strong>Estado:</strong>
        <span style="font-weight:700">{{ sale.get('status','CANCELADO') }}</span>
      </div>

      {% if session.get('role') == 'operador' %}
        {% if sale.get('status') == 'POR PAGAR' %}
        <form method="POST" action="{{ url_for('change_sale_status', receipt=sale['receipt']) }}" style="display:inline-block;margin-right:6px">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="status" value="CANCELADO">
          <button class="btn btn-warning" type="submit">Marcar como CANCELADO</button>
        </form>
        {% endif %}
      {% endif %}

      {# Admin/China: show status form ONLY if NOT CANCELADO #}
      {% if session.get('role') in ['admin', 'China Import'] and sale.get('status') != 'CANCELADO' %}
      <form method="POST" id="statusForm" action="{{ url_for('change_sale_status', receipt=sale['receipt']) }}" style="display:inline-block">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div style="display:flex;gap:6px;align-items:center;">
          <select name="status" id="statusSelect" class="form-select form-select-sm" style="min-width:140px">
            {% for st in ['POR PAGAR','CANCELADO','PARA RECOJO','PARA ENVÍO','ANULADO'] %}
              <option value="{{ st }}" {% if sale.get('status')==st %}selected{% endif %}>{{ st }}</option>
            {% endfor %}
          </select>

          <input type="text" name="annul_reason" id="annulReason" placeholder="Motivo anulación" class="form-control form-control-sm" style="min-width:160px;display:none">

          <button class="btn btn-primary btn-sm" type="submit">Actualizar estado</button>
        </div>
      </form>
      {% endif %}

      {# Payment panel: show for admin/China on POR PAGAR sales only #}
      {% if session.get('role') in ['admin', 'China Import'] and sale.get('status') == 'POR PAGAR' %}
      <div class="no-print" style="margin-top:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">
        <div style="font-weight:700;margin-bottom:6px;">Pagos</div>
        <div style="font-size:11px;margin-bottom:8px;">
          {% for p in sale.get('payments', []) %}
            <div style="color:#555">{{ p.get('ts','')[:19] }} — S/ {{ '%.2f'|format(p.get('amount', 0)) }} — {{ p.get('method','') }}</div>
          {% else %}
            <div style="color:#888">Sin pagos registrados</div>
          {% endfor %}
        </div>
        <form method="POST" action="{{ url_for('add_sale_payment', receipt=sale['receipt']) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <div style="display:flex;gap:4px;flex-wrap:wrap;">
            <input name="amount" type="number" step="0.01" min="0.01" placeholder="Monto" style="width:90px;padding:4px;font-size:11px;" required>
            <input name="method" type="text" placeholder="Método" style="width:100px;padding:4px;font-size:11px;" required>
            <button type="submit" style="padding:4px 8px;font-size:11px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;">Agregar</button>
          </div>
        </form>
      </div>
      {% endif %}

      <button onclick="window.print()" class="btn btn-light btn-sm" style="margin-left:8px">Imprimir</button>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm" style="margin-left:6px">Volver</a>
  </div>

  <script>
      document.addEventListener('DOMContentLoaded', function(){
        var sel = document.getElementById('statusSelect');
        if (!sel) return;
        var ann = document.getElementById('annulReason');
        function toggleFields(){
          var v = sel.value;
          if (ann) ann.style.display = (v === 'ANULADO') ? 'inline-block' : 'none';
        }
        sel.addEventListener('change', toggleFields);
        toggleFields();
      });
    </script>

  </body>
  </html>
