<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ventas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="{{ url_for('static', filename='css/styles.css', v='4') }}" rel="stylesheet">
  <style>
    /* ═══════════════════════════════════════════════════════════════════════════
       ESTILOS PARA FILTROS Y BADGES DE VENTAS
    ═══════════════════════════════════════════════════════════════════════════ */
    
    /* Grupo de filtros */
    .filter-group { margin-bottom: 1rem; }
    .filter-group-label { 
      font-size: 12px; 
      color: var(--text-secondary); 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    /* Botones de filtro con animaciones sutiles */
    .filter-btn {
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .filter-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.2);
      transform: translateY(-1px);
    }
    .filter-btn:active {
      transform: scale(0.97);
    }
    .filter-btn.active {
      background: var(--orange);
      border-color: var(--orange);
      color: #000;
      font-weight: 600;
    }
    
    /* Badges de estado - más claros y semánticos */
    .badge-pagado { background: #28a745 !important; color: #fff !important; }
    .badge-por-pagar { background: #ffc107 !important; color: #000 !important; }
    .badge-recojo { background: #17a2b8 !important; color: #fff !important; }
    .badge-delivery { background: #fd7e14 !important; color: #fff !important; }
    .badge-provincia { background: #6f42c1 !important; color: #fff !important; }
    .badge-anulado { background: #dc3545 !important; color: #fff !important; }
    .badge-completada { background: #155724 !important; color: #fff !important; }
    
    /* Resumen de entrega */
    .delivery-summary { font-size: 13px; color: var(--text-secondary); margin-top: 2px; font-weight: 500; }
    
    /* Indicador de resultados filtrados */
    .filter-results {
      font-size: 14px;
      color: var(--text-secondary);
      padding: 0.5rem 0;
      font-weight: 500;
    }
    .filter-results strong { color: var(--orange); }
    
    /* Fila oculta por filtro */
    .sale-row.filtered-out { display: none !important; }
    
    /* Fila de historial de pagos */
    .history-row { background: rgba(0,0,0,0.25); }
    .history-row.filtered-out { display: none !important; }
    
    /* ═══════════════════════════════════════════════════════════════════════════
       ESTILOS PARA MODAL DE ENTREGA
    ═══════════════════════════════════════════════════════════════════════════ */
    .delivery-modal-header {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 1rem 1.25rem;
    }
    .delivery-modal-header .delivery-icon {
      font-size: 2rem;
      margin-right: 0.75rem;
    }
    .delivery-modal-title {
      font-weight: 700;
      color: var(--orange);
      margin: 0;
    }
    .delivery-modal-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0;
    }
    .delivery-field {
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .delivery-field:last-child {
      border-bottom: none;
    }
    .delivery-field-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }
    .delivery-field-value {
      font-size: 15px;
      color: var(--text);
      font-weight: 500;
    }
    .delivery-empty {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }
    .btn-ver-entrega {
      font-size: 13px;
      padding: 0.2rem 0.5rem;
      margin-left: 6px;
      font-weight: 500;
    }
    
    /* ═══════════════════════════════════════════════════════════════════════════
       RESPONSIVE MÓVIL - SALES PAGE
    ═══════════════════════════════════════════════════════════════════════════ */
    @media (max-width: 768px) {
      /* Header más compacto */
      .d-flex.justify-content-between.align-items-center.mb-3 {
        flex-direction: column;
        align-items: stretch !important;
        gap: 12px;
      }
      .d-flex.justify-content-between.align-items-center.mb-3 h3 {
        font-size: 1.25rem;
      }
      .d-flex.justify-content-between.align-items-center.mb-3 > .d-flex.gap-2 {
        display: flex;
        flex-wrap: wrap;
        gap: 8px !important;
      }
      .d-flex.justify-content-between.align-items-center.mb-3 > .d-flex.gap-2 .btn {
        flex: 1;
        min-width: calc(50% - 4px);
        font-size: 14px;
      }
      
      /* Búsqueda avanzada en columnas */
      form.row.g-2.mb-3 {
        flex-direction: column;
      }
      form.row.g-2.mb-3 [class*="col-md"] {
        width: 100%;
        max-width: 100%;
        flex: 0 0 100%;
      }
      
      /* Filtros en horizontal scrollable */
      .filter-group .btn-group {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
        gap: 6px;
      }
      .filter-btn {
        flex-shrink: 0;
        font-size: 13px;
        padding: 0.35rem 0.6rem;
        white-space: nowrap;
      }
      
      /* OCULTAR TABLA EN MÓVIL */
      .table-responsive {
        display: none !important;
      }
      
      /* MOSTRAR CARDS EN MÓVIL */
      .mobile-sales-cards {
        display: block !important;
      }
      
      /* Stats cards */
      .top-cards .col-md-4 {
        margin-bottom: 8px;
      }
      
      /* Toggle de filtros móvil */
      .filters-toggle-mobile {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px;
        color: var(--text);
        cursor: pointer;
        margin-bottom: 10px;
        font-size: 0.95rem;
        font-weight: 500;
        width: 100%;
      }
      .filters-toggle-mobile:hover {
        background: rgba(255,255,255,0.05);
      }
      .filters-toggle-mobile i:last-child {
        transition: transform 0.25s ease;
      }
      .filters-toggle-mobile.collapsed i:last-child {
        transform: rotate(-90deg);
      }
      
      /* Card de filtros colapsada */
      #filtersCard {
        border-radius: 10px;
        transition: all 0.3s ease;
      }
    }
    
    /* ═══════════════════════════════════════════════════════════════════════════
       CARDS MÓVIL - VENTAS (ocultas en desktop por defecto)
    ═══════════════════════════════════════════════════════════════════════════ */
    .mobile-sales-cards {
      display: none;
    }
    
    .sale-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 10px;
      transition: all 0.2s ease;
    }
    .sale-card:active {
      transform: scale(0.99);
      background: rgba(255,255,255,0.05);
    }
    .sale-card.filtered-out {
      display: none !important;
    }
    
    /* Fila superior: Boleta + Total */
    .sale-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 6px;
    }
    .sale-card-receipt {
      font-weight: 700;
      font-size: 1rem;
      color: var(--orange);
    }
    .sale-card-total {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text);
      text-align: right;
    }
    .sale-card-pending {
      font-size: 0.75rem;
      color: #ffc107;
      font-weight: 500;
    }
    
    /* Segunda línea: Fecha + Usuario */
    .sale-card-meta {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 10px;
    }
    
    /* Badges + Botón */
    .sale-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .sale-card-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .sale-card-badges .badge {
      font-size: 0.7rem;
      padding: 4px 8px;
    }
    .sale-card-action .btn {
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    /* ═══════════════════════════════════════════════════════════════════════════
       VISIBILIDAD DESKTOP / MOBILE
    ═══════════════════════════════════════════════════════════════════════════ */
    .desktop-only { display: block; }
    .mobile-only { display: none !important; }
    form.desktop-only { display: inline-flex; }
    .d-inline-block.desktop-only { display: inline-block; }
    
    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
      /* mobile-only: NO aplicar display aquí, dejar que el elemento defina su propio display cuando active */
    }
    
    /* ═══════════════════════════════════════════════════════════════════════════
       BOTTOM SHEET - Solo móvil
    ═══════════════════════════════════════════════════════════════════════════ */
    /* En desktop: ocultar completamente el bottom sheet */
    @media (min-width: 769px) {
      .bottom-sheet-overlay,
      .bottom-sheet {
        display: none !important;
      }
    }
    .bottom-sheet-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1040;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }
    .bottom-sheet-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1050;
      background: var(--card-bg);
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.4);
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      max-height: 90vh;
      overflow: hidden;
      visibility: hidden;
    }
    .bottom-sheet.active {
      transform: translateY(0);
      visibility: visible;
    }
    
    /* Drag handle */
    .bottom-sheet-handle {
      display: flex;
      justify-content: center;
      padding: 12px 0 8px;
      cursor: grab;
      touch-action: none;
    }
    .bottom-sheet-handle::after {
      content: '';
      width: 40px;
      height: 5px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }
    .bottom-sheet-handle:active { cursor: grabbing; }
    
    /* Header */
    .bottom-sheet-header {
      padding: 0 20px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    .bottom-sheet-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .bottom-sheet-title h5 {
      margin: 0;
      font-weight: 700;
      color: var(--orange);
      font-size: 1.1rem;
    }
    .bottom-sheet-close {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 1.5rem;
      padding: 0;
      cursor: pointer;
      line-height: 1;
    }
    .bottom-sheet-meta {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .bottom-sheet-meta strong {
      color: var(--text);
    }
    
    /* Contenido scrollable */
    .bottom-sheet-content {
      overflow-y: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      max-height: calc(90vh - 100px);
      padding: 16px 20px 30px;
    }
    
    /* Secciones del sheet */
    .sheet-section {
      margin-bottom: 20px;
    }
    .sheet-section:last-child {
      margin-bottom: 0;
    }
    .sheet-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    /* Botones de acción del sheet */
    .sheet-action-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      color: var(--text);
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      margin-bottom: 8px;
    }
    .sheet-action-btn:last-child { margin-bottom: 0; }
    .sheet-action-btn:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    .sheet-action-btn:active {
      transform: scale(0.98);
    }
    .sheet-action-btn i {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }
    .sheet-action-btn.btn-success-soft {
      background: rgba(40, 167, 69, 0.15);
      border-color: rgba(40, 167, 69, 0.3);
    }
    .sheet-action-btn.btn-success-soft i { color: #28a745; }
    .sheet-action-btn.btn-primary-soft {
      background: rgba(13, 110, 253, 0.15);
      border-color: rgba(13, 110, 253, 0.3);
    }
    .sheet-action-btn.btn-primary-soft i { color: #0d6efd; }
    .sheet-action-btn.btn-info-soft {
      background: rgba(13, 202, 240, 0.15);
      border-color: rgba(13, 202, 240, 0.3);
    }
    .sheet-action-btn.btn-info-soft i { color: #0dcaf0; }
    .sheet-action-btn.btn-warning-soft {
      background: rgba(255, 193, 7, 0.15);
      border-color: rgba(255, 193, 7, 0.3);
    }
    .sheet-action-btn.btn-warning-soft i { color: #ffc107; }
    .sheet-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Formulario inline de abonar */
    .sheet-payment-form {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px;
      margin-top: 10px;
      display: none;
    }
    .sheet-payment-form.active { display: block; }
    .sheet-payment-form .form-label {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .sheet-payment-form .form-control,
    .sheet-payment-form .form-select {
      background: rgba(0, 0, 0, 0.2);
      border-color: rgba(255, 255, 255, 0.1);
    }
    
    /* Estado selector inline */
    .sheet-status-form {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px;
      margin-top: 10px;
      display: none;
    }
    .sheet-status-form.active { display: block; }
    
    /* Info entrega en sheet */
    .sheet-delivery-info {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px;
      margin-top: 10px;
      display: none;
    }
    .sheet-delivery-info.active { display: block; }
    .sheet-delivery-field {
      margin-bottom: 12px;
    }
    .sheet-delivery-field:last-child { margin-bottom: 0; }
    .sheet-delivery-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .sheet-delivery-value {
      font-size: 0.95rem;
      color: var(--text);
      font-weight: 500;
    }
    
    /* Historial de pagos */
    .sheet-payment-history {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px;
      margin-top: 10px;
      display: none;
    }
    .sheet-payment-history.active { display: block; }
    .sheet-payment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .sheet-payment-item:last-child { border-bottom: none; }
    .sheet-payment-detail {
      font-size: 0.85rem;
    }
    .sheet-payment-detail small {
      display: block;
      color: var(--muted);
      font-size: 0.75rem;
    }
    .sheet-payment-amount {
      font-weight: 600;
      color: #28a745;
    }
    .sheet-payment-total {
      display: flex;
      justify-content: space-between;
      padding-top: 12px;
      margin-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      font-weight: 600;
    }
  </style>
</head>
<body class="{{ user_theme }}">

<!-- ═══════════════════════════════════════════════════════════════════════════
     MOBILE NAVBAR - Barra superior fija (solo visible en móvil)
═══════════════════════════════════════════════════════════════════════════ -->
<nav class="mobile-navbar hide-desktop">
  <button type="button" class="hamburger-btn" id="mobileMenuToggle" aria-label="Menú">
    <i class="bi bi-list"></i>
  </button>
  <div class="navbar-brand">
    <div class="brand-logo brand-logo--mobile">
      <img src="{{ url_for('static', filename='branding/logo_icon.png') }}" 
           alt="China Import" 
           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
      <div class="brand-logo-fallback brand-logo-fallback--icon" style="display:none;">
        <i class="bi bi-receipt"></i>
      </div>
    </div>
    <span>Ventas</span>
  </div>
  <a href="{{ url_for('dashboard') }}" class="hamburger-btn" aria-label="Volver">
    <i class="bi bi-arrow-left"></i>
  </a>
</nav>

<!-- ═══════════════════════════════════════════════════════════════════════════
     MOBILE SIDEBAR - Menú lateral off-canvas
═══════════════════════════════════════════════════════════════════════════ -->
<div class="mobile-sidebar-overlay hide-desktop" id="mobileSidebarOverlay"></div>
<aside class="mobile-sidebar hide-desktop" id="mobileSidebar">
  <div class="mobile-sidebar-header">
    <div class="brand-logo brand-logo--sidebar">
      <img src="{{ url_for('static', filename='branding/logo_full.png') }}" 
           alt="China Import"
           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
      <span class="brand-logo-fallback" style="display:none;"><i class="bi bi-receipt me-2"></i>Ventas</span>
    </div>
    <button type="button" class="mobile-sidebar-close" id="mobileSidebarClose" aria-label="Cerrar">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
  
  <div class="mobile-sidebar-body">
    <!-- Navegación -->
    <a href="{{ url_for('dashboard') }}" class="mobile-nav-link">
      <i class="bi bi-box-seam"></i>
      <span>Inventario</span>
    </a>
    
    <a href="{{ url_for('sales_page') }}" class="mobile-nav-link active">
      <i class="bi bi-receipt"></i>
      <span>Ver Ventas</span>
    </a>
    
    {% if session.get('role') in ['admin', 'China Import'] %}
    <div class="mobile-nav-divider"></div>
    
    <a href="{{ url_for('profit_stats') }}" class="mobile-nav-link">
      <i class="bi bi-graph-up-arrow"></i>
      <span>Ganancias</span>
    </a>
    
    <a href="{{ url_for('sales_stats') }}" class="mobile-nav-link">
      <i class="bi bi-bar-chart"></i>
      <span>Estadísticas</span>
    </a>
    
    <a href="{{ url_for('audit_page') }}" class="mobile-nav-link">
      <i class="bi bi-clock-history"></i>
      <span>Auditoría</span>
    </a>
    {% endif %}
    
    <div class="mobile-nav-divider"></div>
    
    <a href="{{ url_for('sales_export', **query) }}" class="mobile-nav-link">
      <i class="bi bi-download"></i>
      <span>Exportar CSV</span>
    </a>
    
    <div class="mobile-nav-divider"></div>
    
    <a href="{{ url_for('logout') }}" class="mobile-nav-link">
      <i class="bi bi-box-arrow-right"></i>
      <span>Cerrar sesión</span>
    </a>
  </div>
</aside>
<div class="container py-4">
  
  <!-- ═══════════════════════════════════════════════════════════════════════════
       ENCABEZADO
  ═══════════════════════════════════════════════════════════════════════════ -->
  <div class="d-flex justify-content-between align-items-center mb-3 hide-mobile">
    <h3>Lista de Ventas</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Volver</a>
      {% if session.get('role') in ['admin', 'China Import'] %}
      <a href="{{ url_for('profit_stats') }}" class="btn btn-success"><i class="bi bi-graph-up-arrow me-1"></i>Ganancias</a>
      {% endif %}
      <a href="{{ url_for('sales_export', **query) }}" class="btn btn-primary">Exportar CSV</a>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       BÚSQUEDA AVANZADA (servidor)
  ═══════════════════════════════════════════════════════════════════════════ -->
  <form method="get" class="row g-2 mb-3" id="searchForm">
    <div class="col-md-3"><input name="user" value="{{ query.user or '' }}" placeholder="Usuario" class="form-control"></div>
    <div class="col-md-2"><input name="receipt" value="{{ query.receipt or '' }}" placeholder="Boleta" class="form-control"></div>
    <div class="col-md-3"><input name="q" value="{{ query.q or '' }}" placeholder="Buscar (usuario, SKU, producto...)" class="form-control"></div>
    <div class="col-md-2"><input name="from" value="{{ query.from or '' }}" type="datetime-local" class="form-control"></div>
    <div class="col-md-2 text-end"><button class="btn btn-outline-primary w-100">Buscar</button></div>
  </form>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       FILTROS RÁPIDOS (frontend - sin recarga)
  ═══════════════════════════════════════════════════════════════════════════ -->
  <!-- Toggle móvil para filtros -->
  <button class="filters-toggle-mobile d-block-mobile" type="button" id="filtersToggle">
    <span><i class="bi bi-funnel me-2"></i>Filtros</span>
    <i class="bi bi-chevron-down"></i>
  </button>
  
  <div class="card p-3 mb-3" id="filtersCard" style="background:rgba(255,255,255,0.02);">
    <div class="row">
      <!-- Filtro: Estado de Pago -->
      <div class="col-md-6">
        <div class="filter-group">
          <div class="filter-group-label"><i class="bi bi-cash-coin me-1"></i>Estado de Pago</div>
          <div class="btn-group" role="group">
            <button type="button" class="filter-btn active" data-filter-type="pago" data-filter-value="todas">Todas</button>
            <button type="button" class="filter-btn" data-filter-type="pago" data-filter-value="pagado">
              <span class="badge badge-pagado me-1"><i class="bi bi-check"></i></span> Pagadas
            </button>
            <button type="button" class="filter-btn" data-filter-type="pago" data-filter-value="pendiente">
              <span class="badge badge-por-pagar me-1"><i class="bi bi-clock"></i></span> Por Pagar
            </button>
          </div>
        </div>
      </div>
      
      <!-- Filtro: Tipo de Entrega -->
      <div class="col-md-6">
        <div class="filter-group">
          <div class="filter-group-label"><i class="bi bi-box-seam me-1"></i>Tipo de Entrega</div>
          <div class="btn-group" role="group">
            <button type="button" class="filter-btn active" data-filter-type="entrega" data-filter-value="todas">Todas</button>
            <button type="button" class="filter-btn" data-filter-type="entrega" data-filter-value="recojo">
              <span class="badge badge-recojo me-1"><i class="bi bi-shop"></i></span> Recojo
            </button>
            <button type="button" class="filter-btn" data-filter-type="entrega" data-filter-value="delivery">
              <span class="badge badge-delivery me-1"><i class="bi bi-bicycle"></i></span> Delivery
            </button>
            <button type="button" class="filter-btn" data-filter-type="entrega" data-filter-value="provincia">
              <span class="badge badge-provincia me-1"><i class="bi bi-truck"></i></span> Provincia
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Indicador de resultados -->
    <div class="filter-results" id="filterResults">
      Mostrando <strong id="filteredCount">{{ sales|length }}</strong> de <strong>{{ sales|length }}</strong> ventas
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       TABLA DE VENTAS
  ═══════════════════════════════════════════════════════════════════════════ -->
  <div class="table-responsive">
    <table class="table table-dark table-hover mb-0" id="salesTable">
      <thead>
        <tr>
          <th>Boleta</th>
          <th>Fecha</th>
          <th>Usuario</th>
          <th>Total</th>
          <th>Estado Pago</th>
          <th>Entrega</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="salesBody">
        {% for s in sales %}
        {% set st = s.get('status','CANCELADO') %}
        {% set is_pagado = st in ['CANCELADO', 'PARA RECOJO', 'PARA ENVÍO'] %}
        {% set is_pendiente = st == 'POR PAGAR' %}
        {% set is_anulado = st == 'ANULADO' %}
        {% set is_completada = st == 'COMPLETADA' %}
        {% set delivery = s.get('delivery') %}
        {# Priorizar delivery.tipo, luego delivery_type, luego inferir de status antiguo #}
        {% if delivery and delivery.get('tipo') %}
          {% set delivery_type = delivery.get('tipo') %}
        {% elif s.get('delivery_type') %}
          {% set delivery_type = s.get('delivery_type') %}
        {% elif st == 'PARA ENVÍO' %}
          {% set delivery_type = 'DELIVERY' %}
        {% elif st == 'PARA RECOJO' %}
          {% set delivery_type = 'RECOJO' %}
        {% else %}
          {% set delivery_type = none %}
        {% endif %}
        <tr class="sale-row" 
            data-receipt="{{ s['receipt'] }}"
            data-pago="{{ 'pagado' if is_pagado else ('pendiente' if is_pendiente else 'otro') }}"
            data-entrega="{{ delivery_type|lower if delivery_type else 'sin-tipo' }}"
            data-status="{{ st }}">
          
          <!-- Boleta -->
          <td data-label="Boleta"><strong>{{ s['receipt'] }}</strong></td>
          
          <!-- Fecha -->
          <td data-label="Fecha" class="small">{{ s['ts'][:16].replace('T', ' ') }}</td>
          
          <!-- Usuario -->
          <td data-label="Usuario">{{ s['user'] }}</td>
          
          <!-- Total -->
          <td data-label="Total">
            S/ {{ '%.2f'|format(s['total']) }}
            {% if is_pendiente and s.get('pending_amount', 0) > 0 %}
              <div class="small text-warning">Debe: S/ {{ '%.2f'|format(s.get('pending_amount', s['total'])) }}</div>
            {% endif %}
          </td>
          
          <!-- Estado de Pago (badge semántico) -->
          <td data-label="Estado">
            {% if is_completada %}
              <span class="badge badge-completada"><i class="bi bi-check-circle-fill me-1"></i>COMPLETADA</span>
            {% elif is_anulado %}
              <span class="badge badge-anulado"><i class="bi bi-x-circle-fill me-1"></i>ANULADO</span>
            {% elif is_pagado %}
              <span class="badge badge-pagado"><i class="bi bi-check-circle me-1"></i>PAGADO</span>
            {% elif is_pendiente %}
              <span class="badge badge-por-pagar"><i class="bi bi-clock-history me-1"></i>POR PAGAR</span>
            {% endif %}
          </td>
          
          <!-- Tipo de Entrega (badge + botón ver) -->
          <td data-label="Entrega">
            {% if is_anulado %}
              <span class="text-muted small">—</span>
            {% elif delivery_type == 'RECOJO' %}
              <span class="badge badge-recojo"><i class="bi bi-shop me-1"></i>RECOJO</span>
              <button type="button" class="btn btn-outline-info btn-sm btn-ver-entrega hide-mobile"
                      data-receipt="{{ s['receipt'] }}"
                      data-delivery='{{ (delivery or {})|tojson }}'>
                <i class="bi bi-eye me-1"></i>Ver
              </button>
            {% elif delivery_type == 'DELIVERY' %}
              <span class="badge badge-delivery"><i class="bi bi-bicycle me-1"></i>DELIVERY</span>
              <button type="button" class="btn btn-outline-info btn-sm btn-ver-entrega hide-mobile"
                      data-receipt="{{ s['receipt'] }}"
                      data-delivery='{{ (delivery or {})|tojson }}'>
                <i class="bi bi-eye me-1"></i>Ver
              </button>
            {% elif delivery_type == 'PROVINCIA' %}
              <span class="badge badge-provincia"><i class="bi bi-truck me-1"></i>PROVINCIA</span>
              <button type="button" class="btn btn-outline-info btn-sm btn-ver-entrega hide-mobile"
                      data-receipt="{{ s['receipt'] }}"
                      data-delivery='{{ (delivery or {})|tojson }}'>
                <i class="bi bi-eye me-1"></i>Ver
              </button>
            {% else %}
              <span class="text-muted small">Sin tipo</span>
            {% endif %}
          </td>
          
          <!-- Acciones -->
          <td data-label="">
            <!-- Siempre: Ver/Imprimir -->
            <a class="btn btn-sm btn-outline-light" href="{{ url_for('receipt_page', receipt=s['receipt']) }}">
              <i class="bi bi-receipt me-1"></i>Ver
            </a>

            {% if not is_completada and not is_anulado %}
            <!-- Operador: Marcar como pagado (solo POR PAGAR) -->
            {% if role == 'operador' and is_pendiente %}
            <form method="POST" action="{{ url_for('change_sale_status', receipt=s['receipt']) }}" class="desktop-only" style="display:inline-block;margin-left:6px">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <input type="hidden" name="status" value="CANCELADO">
              <button class="btn btn-success btn-sm" type="submit"><i class="bi bi-check-lg me-1"></i>Marcar Pagado</button>
            </form>
            {% endif %}

            <!-- Admin/China: Cambiar estado (si no está CANCELADO ni COMPLETADA) -->
            {% if role in ['admin', 'China Import'] and st not in ['CANCELADO', 'COMPLETADA'] %}
            <form method="POST" class="status-form d-inline-flex align-items-center desktop-only" 
                  action="{{ url_for('change_sale_status', receipt=s['receipt']) }}" 
                  style="margin-left:6px;gap:4px;" 
                  onsubmit="return confirmAnulado(this)">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <select name="status" class="form-select form-select-sm status-select" style="width:auto;min-width:130px;">
                {% for st_opt in ['POR PAGAR','CANCELADO','PARA RECOJO','PARA ENVÍO','ANULADO'] %}
                  <option value="{{ st_opt }}" {% if st==st_opt %}selected{% endif %}>{{ st_opt }}</option>
                {% endfor %}
              </select>
              <input type="text" name="annul_reason" class="form-control form-control-sm annul-input" 
                     placeholder="Motivo" style="width:140px;display:none;">
              <button class="btn btn-primary btn-sm" type="submit">Cambiar</button>
            </form>
            {% endif %}

            <!-- Botón: Marcar como completada (solo si está pagado y listo) -->
            {% if role in ['admin', 'China Import'] and st in ['CANCELADO', 'PARA RECOJO', 'PARA ENVÍO'] %}
            <button type="button" 
                    class="btn btn-sm btn-success btn-completar-venta anim-pulse btn-glow desktop-only"
                    data-receipt="{{ s['receipt'] }}"
                    style="margin-left:6px;">
              <i class="bi bi-check-circle me-1"></i>Completar
            </button>
            {% endif %}

            <!-- Admin/China: Abonar pago (solo POR PAGAR) -->
            {% if role in ['admin', 'China Import'] and is_pendiente %}
            <div class="dropdown d-inline-block desktop-only" style="margin-left:6px;">
              <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" 
                      data-bs-toggle="dropdown" data-bs-auto-close="outside">
                <i class="bi bi-credit-card me-1"></i>Abonar
              </button>
              <div class="dropdown-menu dropdown-menu-dark p-3" style="min-width:220px;">
                <form method="POST" action="{{ url_for('add_sale_payment', receipt=s['receipt']) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <div class="mb-2">
                    <label class="form-label small text-muted mb-1">Monto (S/)</label>
                    <input name="amount" type="number" step="0.01" min="0.01" 
                           max="{{ s.get('pending_amount', s['total']) }}" 
                           class="form-control form-control-sm" placeholder="0.00" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small text-muted mb-1">Método</label>
                    <select name="method" class="form-select form-select-sm">
                      <option value="Efectivo" selected>Efectivo</option>
                      <option value="Yape">Yape</option>
                      <option value="Plin">Plin</option>
                      <option value="Transferencia">Transferencia</option>
                      <option value="Tarjeta">Tarjeta</option>
                    </select>
                  </div>
                  <button class="btn btn-success btn-sm w-100" type="submit">Confirmar</button>
                </form>
              </div>
            </div>
            
            <!-- Historial de pagos -->
            {% if s.get('payments') and s.get('payments')|length > 0 %}
            <button class="btn btn-outline-info btn-sm desktop-only" type="button" 
                    data-bs-toggle="collapse" data-bs-target="#history-{{ s['receipt'] }}" 
                    title="Ver {{ s.get('payments')|length }} abono(s)" style="margin-left:4px;">
              <i class="bi bi-list-ol me-1"></i>{{ s.get('payments')|length }}
            </button>
            {% endif %}
            {% endif %}
            {% endif %}{# cierra: if not is_completada and not is_anulado #}
          </td>
        </tr>
        
        <!-- Fila colapsable: Historial de pagos -->
        {% if role in ['admin', 'China Import'] and is_pendiente and s.get('payments') and s.get('payments')|length > 0 %}
        <tr class="collapse history-row" id="history-{{ s['receipt'] }}" data-parent="{{ s['receipt'] }}">
          <td colspan="7" style="border:none;padding:12px 20px;">
            <div class="small text-muted mb-2"><strong><i class="bi bi-clock-history me-1"></i>Historial de abonos - {{ s['receipt'] }}</strong></div>
            <table class="table table-sm table-dark mb-0" style="max-width:500px;">
              <thead>
                <tr class="text-muted"><th>Fecha</th><th>Usuario</th><th>Método</th><th class="text-end">Monto</th></tr>
              </thead>
              <tbody>
                {% for pay in s.get('payments', []) %}
                <tr>
                  <td class="small">{{ pay.get('ts', '')[:16].replace('T', ' ') }}</td>
                  <td class="small">{{ pay.get('user', '-') }}</td>
                  <td class="small">{{ pay.get('method', '-') }}</td>
                  <td class="small text-end text-success">S/ {{ '%.2f'|format(pay.get('amount', 0)) }}</td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="border-top">
                  <td colspan="3" class="small text-muted">Total abonado</td>
                  <td class="small text-end text-success fw-bold">S/ {{ '%.2f'|format(s.get('paid_amount', 0)) }}</td>
                </tr>
              </tfoot>
            </table>
          </td>
        </tr>
        {% endif %}
        {% endfor %}
        
        <!-- Sin ventas -->
        {% if sales|length == 0 %}
        <tr id="noSalesRow"><td colspan="7" class="text-center text-muted py-4">Sin ventas</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       CARDS MÓVIL - Solo visible en pantallas pequeñas
  ═══════════════════════════════════════════════════════════════════════════ -->
  <div class="mobile-sales-cards" id="mobileSalesCards">
    {% for s in sales %}
    {% set st = s.get('status','CANCELADO') %}
    {% set is_pagado = st in ['CANCELADO', 'PARA RECOJO', 'PARA ENVÍO'] %}
    {% set is_pendiente = st == 'POR PAGAR' %}
    {% set is_anulado = st == 'ANULADO' %}
    {% set is_completada = st == 'COMPLETADA' %}
    {% set delivery = s.get('delivery') %}
    {% if delivery and delivery.get('tipo') %}
      {% set delivery_type = delivery.get('tipo') %}
    {% elif s.get('delivery_type') %}
      {% set delivery_type = s.get('delivery_type') %}
    {% elif st == 'PARA ENVÍO' %}
      {% set delivery_type = 'DELIVERY' %}
    {% elif st == 'PARA RECOJO' %}
      {% set delivery_type = 'RECOJO' %}
    {% else %}
      {% set delivery_type = none %}
    {% endif %}
    
    <div class="sale-card" 
         data-receipt="{{ s['receipt'] }}"
         data-pago="{{ 'pagado' if is_pagado else ('pendiente' if is_pendiente else 'otro') }}"
         data-entrega="{{ delivery_type|lower if delivery_type else 'sin-tipo' }}"
         data-status="{{ st }}"
         data-total="{{ s['total'] }}"
         data-pending="{{ s.get('pending_amount', 0) }}"
         data-paid="{{ s.get('paid_amount', 0) }}"
         data-payments='{{ (s.get("payments") or [])|tojson }}'
         data-delivery='{{ (delivery or {})|tojson }}'
         data-delivery-type="{{ delivery_type or '' }}"
         data-user="{{ s['user'] }}"
         data-ts="{{ s['ts'][:16].replace('T', ' ') }}">
      
      <!-- Fila 1: Boleta + Total -->
      <div class="sale-card-header">
        <span class="sale-card-receipt">{{ s['receipt'] }}</span>
        <div class="sale-card-total">
          S/ {{ '%.2f'|format(s['total']) }}
          {% if is_pendiente and s.get('pending_amount', 0) > 0 %}
          <div class="sale-card-pending">Debe: S/ {{ '%.2f'|format(s.get('pending_amount', s['total'])) }}</div>
          {% endif %}
        </div>
      </div>
      
      <!-- Fila 2: Fecha + Usuario -->
      <div class="sale-card-meta">
        {{ s['ts'][:16].replace('T', ' ') }} · {{ s['user'] }}
      </div>
      
      <!-- Fila 3: Badges + Botón Ver Detalle -->
      <div class="sale-card-footer">
        <div class="sale-card-badges">
          {% if is_completada %}
            <span class="badge badge-completada"><i class="bi bi-check-circle-fill"></i> Completada</span>
          {% elif is_anulado %}
            <span class="badge badge-anulado"><i class="bi bi-x-circle-fill"></i> Anulado</span>
          {% elif is_pagado %}
            <span class="badge badge-pagado"><i class="bi bi-check-circle"></i> Pagado</span>
          {% elif is_pendiente %}
            <span class="badge badge-por-pagar"><i class="bi bi-clock"></i> Por Pagar</span>
          {% endif %}
          
          {% if not is_anulado and delivery_type %}
            {% if delivery_type == 'RECOJO' %}
              <span class="badge badge-recojo"><i class="bi bi-shop"></i></span>
            {% elif delivery_type == 'DELIVERY' %}
              <span class="badge badge-delivery"><i class="bi bi-bicycle"></i></span>
            {% elif delivery_type == 'PROVINCIA' %}
              <span class="badge badge-provincia"><i class="bi bi-truck"></i></span>
            {% endif %}
          {% endif %}
        </div>
        
        <div class="sale-card-action">
          <button type="button" class="btn btn-primary btn-sm btn-open-sheet"
                  data-receipt="{{ s['receipt'] }}">
            <i class="bi bi-three-dots-vertical me-1"></i>Detalle
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
    
    {% if sales|length == 0 %}
    <div class="text-center text-muted py-4">Sin ventas</div>
    {% endif %}
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     MODAL: Información de Entrega (Desktop)
═══════════════════════════════════════════════════════════════════════════ -->
<div class="modal fade" id="deliveryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1);">
      <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
        <h5 class="modal-title" id="deliveryModalTitle" style="color: var(--orange);"><i class="bi bi-box-seam me-2"></i>Información de Entrega</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="deliveryModalBody">
        <!-- Contenido dinámico -->
      </div>
      <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     BOTTOM SHEET: Detalle de Venta (Solo Móvil)
═══════════════════════════════════════════════════════════════════════════ -->
<div class="bottom-sheet-overlay" id="bottomSheetOverlay"></div>
<div class="bottom-sheet" id="saleBottomSheet">
  <!-- Drag handle -->
  <div class="bottom-sheet-handle" id="bottomSheetHandle"></div>
  
  <!-- Header -->
  <div class="bottom-sheet-header">
    <div class="bottom-sheet-title">
      <h5 id="sheetReceiptTitle"><i class="bi bi-receipt me-2"></i><span id="sheetReceiptNum">---</span></h5>
      <button type="button" class="bottom-sheet-close" id="bottomSheetClose">
        <i class="bi bi-x"></i>
      </button>
    </div>
    <div class="bottom-sheet-meta">
      Total: <strong id="sheetTotal">S/ 0.00</strong>
      <span id="sheetPending" class="text-warning ms-2" style="display:none;">
        (Debe: <strong id="sheetPendingAmt">S/ 0.00</strong>)
      </span>
    </div>
  </div>
  
  <!-- Contenido scrollable -->
  <div class="bottom-sheet-content">
    
    <!-- Acción rápida: Ver boleta -->
    <div class="sheet-section">
      <a href="#" class="sheet-action-btn" id="sheetViewReceipt">
        <i class="bi bi-receipt"></i>
        <span>Ver boleta completa</span>
      </a>
    </div>
    
    <!-- Sección: Pagos (solo para POR PAGAR y admin/china) -->
    <div class="sheet-section" id="sheetPaymentSection" style="display:none;">
      <div class="sheet-section-title"><i class="bi bi-credit-card me-1"></i>Pagos</div>
      
      <!-- Botón abonar -->
      <button type="button" class="sheet-action-btn btn-success-soft" id="sheetTogglePayment">
        <i class="bi bi-plus-circle"></i>
        <span>Abonar pago</span>
      </button>
      
      <!-- Formulario inline -->
      <div class="sheet-payment-form" id="sheetPaymentForm">
        <form id="sheetPaymentFormEl" method="POST" action="">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <div class="mb-3">
            <label class="form-label">Monto (S/)</label>
            <input type="number" name="amount" step="0.01" min="0.01" 
                   class="form-control" placeholder="0.00" required id="sheetPaymentAmount">
          </div>
          <div class="mb-3">
            <label class="form-label">Método de pago</label>
            <select name="method" class="form-select" id="sheetPaymentMethod">
              <option value="Efectivo" selected>Efectivo</option>
              <option value="Yape">Yape</option>
              <option value="Plin">Plin</option>
              <option value="Transferencia">Transferencia</option>
              <option value="Tarjeta">Tarjeta</option>
            </select>
          </div>
          <button type="submit" class="btn btn-success w-100">
            <i class="bi bi-check me-1"></i>Confirmar abono
          </button>
        </form>
      </div>
      
      <!-- Botón historial (si hay pagos) -->
      <button type="button" class="sheet-action-btn btn-info-soft" id="sheetToggleHistory" style="display:none;">
        <i class="bi bi-clock-history"></i>
        <span>Historial de abonos (<span id="sheetPaymentsCount">0</span>)</span>
      </button>
      
      <!-- Historial de pagos -->
      <div class="sheet-payment-history" id="sheetPaymentHistory">
        <div id="sheetPaymentList"></div>
        <div class="sheet-payment-total">
          <span>Total abonado</span>
          <span class="text-success" id="sheetPaidTotal">S/ 0.00</span>
        </div>
      </div>
    </div>
    
    <!-- Sección: Estado de venta (admin/china y no CANCELADO/COMPLETADA) -->
    <div class="sheet-section" id="sheetStatusSection" style="display:none;">
      <div class="sheet-section-title"><i class="bi bi-arrow-repeat me-1"></i>Estado</div>
      
      <button type="button" class="sheet-action-btn btn-primary-soft" id="sheetToggleStatus">
        <i class="bi bi-pencil-square"></i>
        <span>Cambiar estado</span>
      </button>
      
      <div class="sheet-status-form" id="sheetStatusForm">
        <form id="sheetStatusFormEl" method="POST" action="">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <div class="mb-3">
            <label class="form-label">Nuevo estado</label>
            <select name="status" class="form-select" id="sheetStatusSelect">
              <option value="POR PAGAR">POR PAGAR</option>
              <option value="CANCELADO">CANCELADO (Pagado)</option>
              <option value="PARA RECOJO">PARA RECOJO</option>
              <option value="PARA ENVÍO">PARA ENVÍO</option>
              <option value="ANULADO">ANULADO</option>
            </select>
          </div>
          <div class="mb-3" id="sheetAnnulReasonDiv" style="display:none;">
            <label class="form-label">Motivo de anulación</label>
            <input type="text" name="annul_reason" class="form-control" 
                   placeholder="Ingresa el motivo..." id="sheetAnnulReason">
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-check me-1"></i>Cambiar estado
          </button>
        </form>
      </div>
    </div>
    
    <!-- Sección: Completar venta (admin/china y CANCELADO/PARA RECOJO/PARA ENVÍO) -->
    <div class="sheet-section" id="sheetCompleteSection" style="display:none;">
      <div class="sheet-section-title"><i class="bi bi-check-circle me-1"></i>Finalizar</div>
      
      <button type="button" class="sheet-action-btn btn-success-soft" id="sheetCompleteBtn">
        <i class="bi bi-check-circle-fill"></i>
        <span>Marcar como COMPLETADA</span>
      </button>
    </div>
    
    <!-- Sección: Entrega -->
    <div class="sheet-section" id="sheetDeliverySection" style="display:none;">
      <div class="sheet-section-title"><i class="bi bi-box-seam me-1"></i>Información de entrega</div>
      
      <button type="button" class="sheet-action-btn btn-info-soft" id="sheetToggleDelivery">
        <i class="bi bi-geo-alt"></i>
        <span>Ver datos de entrega</span>
      </button>
      
      <div class="sheet-delivery-info" id="sheetDeliveryInfo">
        <!-- Contenido dinámico -->
      </div>
    </div>
    
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ═══════════════════════════════════════════════════════════════════════════
// MODAL DE INFORMACIÓN DE ENTREGA
// ═══════════════════════════════════════════════════════════════════════════

(function() {
  'use strict';
  
  // Escape HTML para evitar XSS
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Renderizar campo solo si tiene valor
  function field(label, value, icon = '') {
    if (!value || String(value).trim() === '') return '';
    return `
      <div class="delivery-field">
        <div class="delivery-field-label">${icon} ${label}</div>
        <div class="delivery-field-value">${escapeHtml(String(value))}</div>
      </div>
    `;
  }
  
  // Generar HTML según tipo de entrega
  function renderDeliveryContent(delivery, receipt) {
    if (!delivery || Object.keys(delivery).length === 0) {
      return '<div class="text-center text-muted py-3">No hay información de entrega registrada</div>';
    }
    
    const tipo = delivery.tipo || 'RECOJO';
    let html = `<p class="text-muted small mb-3">Boleta: <strong>${escapeHtml(receipt)}</strong></p>`;
    
    if (tipo === 'RECOJO') {
      html += `
        <div class="delivery-field">
          <div class="delivery-field-label"><i class="bi bi-box-seam"></i> Tipo de entrega</div>
          <div class="delivery-field-value"><span class="badge badge-recojo"><i class="bi bi-shop me-1"></i>RECOJO</span></div>
        </div>
      `;
      html += field('Nombre del cliente', delivery.nombre, '<i class="bi bi-person"></i>');
      html += field('Teléfono', delivery.telefono, '<i class="bi bi-telephone"></i>');
      html += field('Observación', delivery.observacion, '<i class="bi bi-chat-text"></i>');
      
      if (!delivery.nombre && !delivery.telefono && !delivery.observacion) {
        html += '<p class="text-muted small mt-3">El cliente recogerá en tienda. No hay datos adicionales.</p>';
      }
    }
    
    else if (tipo === 'DELIVERY') {
      html += `
        <div class="delivery-field">
          <div class="delivery-field-label"><i class="bi bi-box-seam"></i> Tipo de entrega</div>
          <div class="delivery-field-value"><span class="badge badge-delivery"><i class="bi bi-bicycle me-1"></i>DELIVERY</span></div>
        </div>
      `;
      html += field('Dirección de entrega', delivery.direccion, '<i class="bi bi-geo-alt"></i>');
      html += field('Teléfono de contacto', delivery.telefono, '<i class="bi bi-telephone"></i>');
      html += field('Referencia', delivery.referencia, '<i class="bi bi-house"></i>');
      html += field('Observación', delivery.observacion, '<i class="bi bi-chat-text"></i>');
    }
    
    else if (tipo === 'PROVINCIA') {
      html += `
        <div class="delivery-field">
          <div class="delivery-field-label"><i class="bi bi-box-seam"></i> Tipo de entrega</div>
          <div class="delivery-field-value"><span class="badge badge-provincia"><i class="bi bi-truck me-1"></i>PROVINCIA</span></div>
        </div>
      `;
      html += field('Agencia de envío', delivery.agencia, '<i class="bi bi-building"></i>');
      html += field('Ciudad / Departamento', delivery.ciudad, '<i class="bi bi-pin-map"></i>');
      html += field('Nombre del destinatario', delivery.nombre, '<i class="bi bi-person"></i>');
      html += field('DNI del destinatario', delivery.dni, '<i class="bi bi-card-text"></i>');
      html += field('Teléfono de contacto', delivery.telefono, '<i class="bi bi-telephone"></i>');
      html += field('Observación', delivery.observacion, '<i class="bi bi-chat-text"></i>');
    }
    
    else {
      html += '<p class="text-muted">Tipo de entrega no reconocido</p>';
    }
    
    return html;
  }
  
  // Event listener para botones "Ver entrega"
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-ver-entrega').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const receipt = this.dataset.receipt || '---';
        let delivery = {};
        
        try {
          delivery = JSON.parse(this.dataset.delivery || '{}');
        } catch (e) {
          delivery = {};
        }
        
        // Actualizar título con icono según tipo
        const tipo = delivery.tipo || 'RECOJO';
        const icons = { 'RECOJO': '<i class="bi bi-shop me-2"></i>', 'DELIVERY': '<i class="bi bi-bicycle me-2"></i>', 'PROVINCIA': '<i class="bi bi-truck me-2"></i>' };
        const titles = { 'RECOJO': 'Recojo en tienda', 'DELIVERY': 'Delivery (Lima)', 'PROVINCIA': 'Envío a Provincia' };
        
        document.getElementById('deliveryModalTitle').innerHTML = 
          (icons[tipo] || '<i class="bi bi-box-seam me-2"></i>') + (titles[tipo] || 'Información de Entrega');
        
        // Renderizar contenido
        document.getElementById('deliveryModalBody').innerHTML = renderDeliveryContent(delivery, receipt);
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('deliveryModal'));
        modal.show();
      });
    });
  });
  
})();

// ═══════════════════════════════════════════════════════════════════════════
// SISTEMA DE FILTRADO FRONTEND - Sin recarga de página
// ═══════════════════════════════════════════════════════════════════════════

(function() {
  'use strict';
  
  // Estado actual de los filtros
  const filterState = {
    pago: 'todas',
    entrega: 'todas'
  };
  
  // Referencias DOM
  const salesBody = document.getElementById('salesBody');
  const mobileSalesCards = document.getElementById('mobileSalesCards');
  const filteredCountEl = document.getElementById('filteredCount');
  const filterButtons = document.querySelectorAll('.filter-btn');
  
  /**
   * Aplica los filtros actuales a todas las filas de ventas (tabla y cards móvil)
   */
  function applyFilters() {
    const rows = salesBody.querySelectorAll('.sale-row');
    const cards = mobileSalesCards ? mobileSalesCards.querySelectorAll('.sale-card') : [];
    let visibleCount = 0;
    
    // Filtrar filas de tabla (desktop)
    rows.forEach(row => {
      const rowPago = row.dataset.pago;
      const rowEntrega = row.dataset.entrega;
      const receipt = row.dataset.receipt;
      
      // Verificar filtro de pago
      let matchPago = filterState.pago === 'todas' || rowPago === filterState.pago;
      
      // Verificar filtro de entrega
      let matchEntrega = filterState.entrega === 'todas' || rowEntrega === filterState.entrega;
      
      // Mostrar/ocultar fila
      const shouldShow = matchPago && matchEntrega;
      row.classList.toggle('filtered-out', !shouldShow);
      
      // También ocultar fila de historial asociada
      const historyRow = document.querySelector(`.history-row[data-parent="${receipt}"]`);
      if (historyRow) {
        historyRow.classList.toggle('filtered-out', !shouldShow);
      }
      
      if (shouldShow) visibleCount++;
    });
    
    // Filtrar cards móvil
    cards.forEach(card => {
      const cardPago = card.dataset.pago;
      const cardEntrega = card.dataset.entrega;
      
      let matchPago = filterState.pago === 'todas' || cardPago === filterState.pago;
      let matchEntrega = filterState.entrega === 'todas' || cardEntrega === filterState.entrega;
      
      const shouldShow = matchPago && matchEntrega;
      card.classList.toggle('filtered-out', !shouldShow);
    });
    
    // Actualizar contador
    if (filteredCountEl) {
      filteredCountEl.textContent = visibleCount;
    }
    
    // Mostrar mensaje si no hay resultados
    const noResultsRow = document.getElementById('noFilterResults');
    if (visibleCount === 0 && rows.length > 0) {
      if (!noResultsRow) {
        const tr = document.createElement('tr');
        tr.id = 'noFilterResults';
        tr.innerHTML = '<td colspan="7" class="text-center text-muted py-4">No hay ventas que coincidan con los filtros seleccionados</td>';
        salesBody.appendChild(tr);
      }
    } else if (noResultsRow) {
      noResultsRow.remove();
    }
  }
  
  /**
   * Maneja el click en un botón de filtro
   */
  function handleFilterClick(e) {
    const btn = e.currentTarget;
    const filterType = btn.dataset.filterType;
    const filterValue = btn.dataset.filterValue;
    
    // Actualizar estado
    filterState[filterType] = filterValue;
    
    // Actualizar UI: marcar botón activo
    document.querySelectorAll(`.filter-btn[data-filter-type="${filterType}"]`).forEach(b => {
      b.classList.toggle('active', b.dataset.filterValue === filterValue);
    });
    
    // Aplicar filtros
    applyFilters();
  }
  
  /**
   * Confirmar anulación de venta
   */
  window.confirmAnulado = function(form) {
    const sel = form.querySelector('select[name="status"]');
    if (!sel) return true;
    if (sel.value === 'ANULADO') {
      return confirm('¿Confirmar ANULACIÓN de la venta? Esta acción revertirá el stock.');
    }
    return true;
  };
  
  /**
   * Inicialización
   */
  document.addEventListener('DOMContentLoaded', function() {
    // Agregar listeners a botones de filtro
    filterButtons.forEach(btn => {
      btn.addEventListener('click', handleFilterClick);
    });
    
    // Toggle para input de motivo de anulación
    document.querySelectorAll('.status-form').forEach(form => {
      const sel = form.querySelector('.status-select');
      const ann = form.querySelector('.annul-input');
      if (!sel || !ann) return;
      
      function toggle() {
        ann.style.display = (sel.value === 'ANULADO') ? 'inline-block' : 'none';
      }
      sel.addEventListener('change', toggle);
      toggle();
    });
  });
  
})();

// ═══════════════════════════════════════════════════════════════════════════
// MARCAR VENTA COMO COMPLETADA
// ═══════════════════════════════════════════════════════════════════════════

(function() {
  'use strict';
  
  const CSRF_TOKEN = document.querySelector('input[name="csrf_token"]')?.value || '';
  
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-completar-venta').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const receipt = this.dataset.receipt;
        const row = btn.closest('tr');
        
        if (!confirm('¿Confirmar que la venta ' + receipt + ' fue entregada al cliente?')) {
          return;
        }
        
        // Deshabilitar botón mientras procesa
        btn.disabled = true;
        btn.innerHTML = '<span class="anim-spin d-inline-block"><i class="bi bi-arrow-repeat"></i></span> Procesando...';
        
        fetch('/sales/' + receipt + '/complete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: 'csrf_token=' + encodeURIComponent(CSRF_TOKEN)
        })
        .then(function(response) {
          return response.json().then(function(data) {
            return { ok: response.ok, data: data };
          });
        })
        .then(function(result) {
          if (result.ok && result.data.ok) {
            // Animación de éxito antes de recargar
            btn.classList.add('anim-pulse-success');
            btn.innerHTML = '<i class="bi bi-check-circle-fill me-1 anim-check"></i>¡Completada!';
            if (row) {
              row.style.transition = 'background-color 0.3s ease';
              row.style.backgroundColor = 'rgba(40, 167, 69, 0.2)';
            }
            setTimeout(function() {
              window.location.reload();
            }, 600);
          } else {
            // Error del servidor - shake
            btn.classList.add('anim-shake');
            setTimeout(function() { btn.classList.remove('anim-shake'); }, 300);
            alert('Error: ' + (result.data.error || 'No se pudo completar la venta'));
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Completar';
          }
        })
        .catch(function(err) {
          btn.classList.add('anim-shake');
          setTimeout(function() { btn.classList.remove('anim-shake'); }, 300);
          alert('Error de conexión: ' + err.message);
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Completar';
        });
      });
    });
  });
  
})();

// ═══════════════════════════════════════════════════════════════════════════
// MOBILE SIDEBAR - Control del menú lateral móvil
// ═══════════════════════════════════════════════════════════════════════════
(function initMobileSidebar() {
  const menuToggle = document.getElementById('mobileMenuToggle');
  const sidebar = document.getElementById('mobileSidebar');
  const overlay = document.getElementById('mobileSidebarOverlay');
  const closeBtn = document.getElementById('mobileSidebarClose');
  
  if (!menuToggle || !sidebar || !overlay) return;
  
  function openSidebar() {
    sidebar.classList.add('active');
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
  
  function closeSidebar() {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
  }
  
  menuToggle.addEventListener('click', openSidebar);
  closeBtn?.addEventListener('click', closeSidebar);
  overlay.addEventListener('click', closeSidebar);
  
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && sidebar.classList.contains('active')) closeSidebar();
  });
  
  const mediaQuery = window.matchMedia('(min-width: 769px)');
  mediaQuery.addEventListener('change', e => { if (e.matches) closeSidebar(); });
})();

// ═══════════════════════════════════════════════════════════════════════════
// FILTROS COLAPSABLES EN MÓVIL
// ═══════════════════════════════════════════════════════════════════════════
(function initMobileFilters() {
  const toggle = document.getElementById('filtersToggle');
  const card = document.getElementById('filtersCard');
  
  if (!toggle || !card) return;
  
  // Solo aplica en móvil
  function isMobile() {
    return window.innerWidth <= 768;
  }
  
  // Estado inicial: colapsado en móvil
  function initState() {
    if (isMobile()) {
      card.style.display = 'none';
      toggle.classList.add('collapsed');
    } else {
      card.style.display = '';
      toggle.classList.remove('collapsed');
    }
  }
  
  initState();
  
  toggle.addEventListener('click', function() {
    const isCollapsed = toggle.classList.contains('collapsed');
    if (isCollapsed) {
      card.style.display = '';
      toggle.classList.remove('collapsed');
    } else {
      card.style.display = 'none';
      toggle.classList.add('collapsed');
    }
  });
  
  // Reset cuando cambia el tamaño de pantalla
  window.addEventListener('resize', function() {
    if (!isMobile()) {
      card.style.display = '';
      toggle.classList.remove('collapsed');
    }
  });
})();

// ═══════════════════════════════════════════════════════════════════════════
// BOTTOM SHEET - Panel de detalle de venta (Solo Móvil)
// ═══════════════════════════════════════════════════════════════════════════
(function initBottomSheet() {
  'use strict';
  
  // Referencias DOM
  const overlay = document.getElementById('bottomSheetOverlay');
  const sheet = document.getElementById('saleBottomSheet');
  const handle = document.getElementById('bottomSheetHandle');
  const closeBtn = document.getElementById('bottomSheetClose');
  
  if (!sheet || !overlay) return;
  
  // Constantes
  const ROLE = '{{ role }}';
  const CSRF_TOKEN = document.querySelector('input[name="csrf_token"]')?.value || '';
  const CAN_EDIT = ROLE === 'admin' || ROLE === 'China Import';
  
  // Estado actual
  let currentSale = null;
  let startY = 0;
  let currentY = 0;
  let isDragging = false;
  
  // ─────────────────────────────────────────────────────────────────────────
  // FUNCIONES DE APERTURA/CIERRE
  // ─────────────────────────────────────────────────────────────────────────
  
  function openSheet(saleData) {
    currentSale = saleData;
    populateSheet(saleData);
    
    sheet.classList.add('active');
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Resetear scroll del contenido
    const content = sheet.querySelector('.bottom-sheet-content');
    if (content) content.scrollTop = 0;
    
    // Resetear formularios
    resetAllForms();
  }
  
  function closeSheet() {
    sheet.classList.remove('active');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
    currentSale = null;
  }
  
  function resetAllForms() {
    // Ocultar todos los formularios expandibles
    document.querySelectorAll('.sheet-payment-form, .sheet-status-form, .sheet-delivery-info, .sheet-payment-history').forEach(el => {
      el.classList.remove('active');
    });
    
    // Reset form fields
    const paymentForm = document.getElementById('sheetPaymentFormEl');
    if (paymentForm) paymentForm.reset();
  }
  
  // ─────────────────────────────────────────────────────────────────────────
  // POBLAR EL SHEET CON DATOS DE LA VENTA
  // ─────────────────────────────────────────────────────────────────────────
  
  function populateSheet(sale) {
    const receipt = sale.receipt;
    const status = sale.status;
    const total = parseFloat(sale.total) || 0;
    const pending = parseFloat(sale.pending) || 0;
    const paid = parseFloat(sale.paid) || 0;
    const payments = sale.payments || [];
    const delivery = sale.delivery || {};
    const deliveryType = sale.deliveryType || '';
    
    const isPendiente = status === 'POR PAGAR';
    const isPagado = ['CANCELADO', 'PARA RECOJO', 'PARA ENVÍO'].includes(status);
    const isAnulado = status === 'ANULADO';
    const isCompletada = status === 'COMPLETADA';
    const canComplete = isPagado && CAN_EDIT;
    const canChangeStatus = CAN_EDIT && !['CANCELADO', 'COMPLETADA'].includes(status);
    const canAddPayment = CAN_EDIT && isPendiente;
    const hasDelivery = deliveryType && !isAnulado;
    
    // Header
    document.getElementById('sheetReceiptNum').textContent = receipt;
    document.getElementById('sheetTotal').textContent = 'S/ ' + total.toFixed(2);
    
    const pendingEl = document.getElementById('sheetPending');
    const pendingAmtEl = document.getElementById('sheetPendingAmt');
    if (isPendiente && pending > 0) {
      pendingEl.style.display = '';
      pendingAmtEl.textContent = 'S/ ' + pending.toFixed(2);
    } else {
      pendingEl.style.display = 'none';
    }
    
    // Link ver boleta
    document.getElementById('sheetViewReceipt').href = '/receipt/' + receipt;
    
    // Sección de Pagos
    const paymentSection = document.getElementById('sheetPaymentSection');
    if (canAddPayment) {
      paymentSection.style.display = '';
      
      // Configurar form action
      const paymentForm = document.getElementById('sheetPaymentFormEl');
      paymentForm.action = '/sales/' + receipt + '/payment';
      
      // Configurar max amount
      const amountInput = document.getElementById('sheetPaymentAmount');
      amountInput.max = pending;
      
      // Botón e historial de pagos
      const historyBtn = document.getElementById('sheetToggleHistory');
      const paymentsCountEl = document.getElementById('sheetPaymentsCount');
      if (payments.length > 0) {
        historyBtn.style.display = '';
        paymentsCountEl.textContent = payments.length;
        renderPaymentHistory(payments, paid);
      } else {
        historyBtn.style.display = 'none';
      }
    } else {
      paymentSection.style.display = 'none';
    }
    
    // Sección de Estado
    const statusSection = document.getElementById('sheetStatusSection');
    if (canChangeStatus) {
      statusSection.style.display = '';
      
      // Configurar form action
      const statusForm = document.getElementById('sheetStatusFormEl');
      statusForm.action = '/sales/' + receipt + '/status';
      
      // Seleccionar estado actual
      const statusSelect = document.getElementById('sheetStatusSelect');
      statusSelect.value = status;
      updateAnnulReasonVisibility();
    } else {
      statusSection.style.display = 'none';
    }
    
    // Sección de Completar
    const completeSection = document.getElementById('sheetCompleteSection');
    if (canComplete) {
      completeSection.style.display = '';
    } else {
      completeSection.style.display = 'none';
    }
    
    // Sección de Entrega
    const deliverySection = document.getElementById('sheetDeliverySection');
    if (hasDelivery) {
      deliverySection.style.display = '';
      renderDeliveryInfo(delivery, deliveryType);
    } else {
      deliverySection.style.display = 'none';
    }
  }
  
  // ─────────────────────────────────────────────────────────────────────────
  // RENDERIZAR HISTORIAL DE PAGOS
  // ─────────────────────────────────────────────────────────────────────────
  
  function renderPaymentHistory(payments, totalPaid) {
    const listEl = document.getElementById('sheetPaymentList');
    const totalEl = document.getElementById('sheetPaidTotal');
    
    let html = '';
    payments.forEach(pay => {
      const ts = (pay.ts || '').substring(0, 16).replace('T', ' ');
      html += '<div class="sheet-payment-item">';
      html += '<div class="sheet-payment-detail">';
      html += '<span>' + escapeHtml(pay.method || '-') + '</span>';
      html += '<small>' + escapeHtml(ts) + ' · ' + escapeHtml(pay.user || '-') + '</small>';
      html += '</div>';
      html += '<span class="sheet-payment-amount">S/ ' + (parseFloat(pay.amount) || 0).toFixed(2) + '</span>';
      html += '</div>';
    });
    
    listEl.innerHTML = html;
    totalEl.textContent = 'S/ ' + (totalPaid || 0).toFixed(2);
  }
  
  // ─────────────────────────────────────────────────────────────────────────
  // RENDERIZAR INFO DE ENTREGA
  // ─────────────────────────────────────────────────────────────────────────
  
  function renderDeliveryInfo(delivery, tipo) {
    const container = document.getElementById('sheetDeliveryInfo');
    let html = '';
    
    // Badge de tipo
    const badges = {
      'RECOJO': '<span class="badge badge-recojo"><i class="bi bi-shop me-1"></i>RECOJO</span>',
      'DELIVERY': '<span class="badge badge-delivery"><i class="bi bi-bicycle me-1"></i>DELIVERY</span>',
      'PROVINCIA': '<span class="badge badge-provincia"><i class="bi bi-truck me-1"></i>PROVINCIA</span>'
    };
    
    html += '<div class="sheet-delivery-field">';
    html += '<div class="sheet-delivery-label">Tipo de entrega</div>';
    html += '<div class="sheet-delivery-value">' + (badges[tipo] || tipo) + '</div>';
    html += '</div>';
    
    function field(label, value) {
      if (!value) return '';
      return '<div class="sheet-delivery-field">' +
             '<div class="sheet-delivery-label">' + label + '</div>' +
             '<div class="sheet-delivery-value">' + escapeHtml(value) + '</div>' +
             '</div>';
    }
    
    if (tipo === 'RECOJO') {
      html += field('Nombre del cliente', delivery.nombre);
      html += field('Teléfono', delivery.telefono);
      html += field('Observación', delivery.observacion);
    } else if (tipo === 'DELIVERY') {
      html += field('Dirección', delivery.direccion);
      html += field('Teléfono', delivery.telefono);
      html += field('Referencia', delivery.referencia);
      html += field('Observación', delivery.observacion);
    } else if (tipo === 'PROVINCIA') {
      html += field('Agencia', delivery.agencia);
      html += field('Ciudad', delivery.ciudad);
      html += field('Nombre destinatario', delivery.nombre);
      html += field('DNI', delivery.dni);
      html += field('Teléfono', delivery.telefono);
      html += field('Observación', delivery.observacion);
    }
    
    container.innerHTML = html || '<p class="text-muted small">Sin información adicional</p>';
  }
  
  // ─────────────────────────────────────────────────────────────────────────
  // HELPERS
  // ─────────────────────────────────────────────────────────────────────────
  
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function updateAnnulReasonVisibility() {
    const select = document.getElementById('sheetStatusSelect');
    const reasonDiv = document.getElementById('sheetAnnulReasonDiv');
    if (select && reasonDiv) {
      reasonDiv.style.display = select.value === 'ANULADO' ? '' : 'none';
    }
  }
  
  // ─────────────────────────────────────────────────────────────────────────
  // SWIPE TO CLOSE (Touch gestures)
  // ─────────────────────────────────────────────────────────────────────────
  
  function handleTouchStart(e) {
    if (!e.target.closest('.bottom-sheet-handle')) return;
    isDragging = true;
    startY = e.touches[0].clientY;
    sheet.style.transition = 'none';
  }
  
  function handleTouchMove(e) {
    if (!isDragging) return;
    currentY = e.touches[0].clientY;
    const deltaY = currentY - startY;
    
    if (deltaY > 0) {
      sheet.style.transform = 'translateY(' + deltaY + 'px)';
    }
  }
  
  function handleTouchEnd() {
    if (!isDragging) return;
    isDragging = false;
    
    const deltaY = currentY - startY;
    sheet.style.transition = '';
    
    if (deltaY > 100) {
      closeSheet();
    } else {
      sheet.style.transform = '';
    }
  }
  
  // ─────────────────────────────────────────────────────────────────────────
  // ACCIONES DEL SHEET
  // ─────────────────────────────────────────────────────────────────────────
  
  // Completar venta
  function handleComplete() {
    if (!currentSale) return;
    const receipt = currentSale.receipt;
    
    if (!confirm('¿Confirmar que la venta ' + receipt + ' fue entregada al cliente?')) {
      return;
    }
    
    const btn = document.getElementById('sheetCompleteBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat anim-spin"></i> Procesando...';
    
    fetch('/sales/' + receipt + '/complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'csrf_token=' + encodeURIComponent(CSRF_TOKEN)
    })
    .then(r => r.json().then(data => ({ ok: r.ok, data })))
    .then(result => {
      if (result.ok && result.data.ok) {
        btn.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>¡Completada!';
        setTimeout(() => window.location.reload(), 500);
      } else {
        alert('Error: ' + (result.data.error || 'No se pudo completar'));
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Marcar como COMPLETADA';
      }
    })
    .catch(err => {
      alert('Error de conexión');
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Marcar como COMPLETADA';
    });
  }
  
  // ─────────────────────────────────────────────────────────────────────────
  // EVENT LISTENERS
  // ─────────────────────────────────────────────────────────────────────────
  
  document.addEventListener('DOMContentLoaded', function() {
    
    // Abrir sheet desde botón en card
    document.querySelectorAll('.btn-open-sheet').forEach(btn => {
      btn.addEventListener('click', function() {
        const card = this.closest('.sale-card');
        if (!card) return;
        
        const saleData = {
          receipt: card.dataset.receipt,
          status: card.dataset.status,
          total: card.dataset.total,
          pending: card.dataset.pending,
          paid: card.dataset.paid,
          payments: JSON.parse(card.dataset.payments || '[]'),
          delivery: JSON.parse(card.dataset.delivery || '{}'),
          deliveryType: card.dataset.deliveryType
        };
        
        openSheet(saleData);
      });
    });
    
    // Cerrar sheet
    closeBtn?.addEventListener('click', closeSheet);
    overlay?.addEventListener('click', closeSheet);
    
    // Escape key
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && sheet.classList.contains('active')) closeSheet();
    });
    
    // Swipe gestures
    handle?.addEventListener('touchstart', handleTouchStart, { passive: true });
    document.addEventListener('touchmove', handleTouchMove, { passive: true });
    document.addEventListener('touchend', handleTouchEnd);
    
    // Toggle formulario de pago
    document.getElementById('sheetTogglePayment')?.addEventListener('click', function() {
      document.getElementById('sheetPaymentForm')?.classList.toggle('active');
    });
    
    // Toggle historial de pagos
    document.getElementById('sheetToggleHistory')?.addEventListener('click', function() {
      document.getElementById('sheetPaymentHistory')?.classList.toggle('active');
    });
    
    // Toggle formulario de estado
    document.getElementById('sheetToggleStatus')?.addEventListener('click', function() {
      document.getElementById('sheetStatusForm')?.classList.toggle('active');
    });
    
    // Toggle info de entrega
    document.getElementById('sheetToggleDelivery')?.addEventListener('click', function() {
      document.getElementById('sheetDeliveryInfo')?.classList.toggle('active');
    });
    
    // Visibilidad de motivo de anulación
    document.getElementById('sheetStatusSelect')?.addEventListener('change', updateAnnulReasonVisibility);
    
    // Botón completar
    document.getElementById('sheetCompleteBtn')?.addEventListener('click', handleComplete);
    
    // Form submit de estado (confirmar anulación)
    document.getElementById('sheetStatusFormEl')?.addEventListener('submit', function(e) {
      const select = document.getElementById('sheetStatusSelect');
      if (select && select.value === 'ANULADO') {
        if (!confirm('¿Confirmar ANULACIÓN de la venta? Esta acción revertirá el stock.')) {
          e.preventDefault();
        }
      }
    });
    
    // Cerrar sheet al cambiar a desktop
    const mediaQuery = window.matchMedia('(min-width: 769px)');
    mediaQuery.addEventListener('change', e => {
      if (e.matches && sheet.classList.contains('active')) closeSheet();
    });
  });
  
})();
</script>
</body>
</html>