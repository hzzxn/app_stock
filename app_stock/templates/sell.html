<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ventas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="{{ url_for('static', filename='css/styles.css', v='4') }}" rel="stylesheet">
</head>
<body class="{{ user_theme }}">

<!-- ═══════════════════════════════════════════════════════════════════════════
     MOBILE NAVBAR
═══════════════════════════════════════════════════════════════════════════ -->
<nav class="mobile-navbar hide-desktop">
  <a href="{{ url_for('dashboard') }}" class="hamburger-btn" aria-label="Volver">
    <i class="bi bi-arrow-left"></i>
  </a>
  <div class="navbar-brand">
    <div class="brand-logo brand-logo--mobile">
      <img src="{{ url_for('static', filename='branding/logo_icon.png') }}" alt="China Import" 
           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
      <div class="brand-logo-fallback brand-logo-fallback--icon" style="display:none;">
        <i class="bi bi-cart-plus"></i>
      </div>
    </div>
    <span>Registrar Venta</span>
  </div>
  <div style="width:44px;"></div>
</nav>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Registrar Venta</h3>
    <div>
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Volver</a>
      <a href="{{ url_for('logout') }}" class="btn btn-secondary">Salir</a>
    </div>
  </div>
  <div class="mb-3">
    <p class="form-help">Precio ingresado es final (incluye IGV).</p>
  </div>

  <div class="row">
    <div class="col-md-7">
      <div class="list-group">
        {% for pid,p in inventario.items() %}
          <div class="list-group-item d-flex align-items-center justify-content-between">
            <div>
              <div><strong>{{ p.nombre }}</strong> <small class="text-muted">SKU {{ p.sku }}</small></div>
              <div class="small">Stock: {{ p.cantidad }}</div>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <input type="number" min="0" class="form-control form-control-sm qty" data-pid="{{ pid }}" placeholder="Cant." style="width:80px;">
              <input type="number" min="0" step="0.01" class="form-control form-control-sm price" data-pid="{{ pid }}" placeholder="Precio (incl. IGV)" style="width:110px;">
              <button class="btn btn-sm btn-primary add-item" data-pid="{{ pid }}">Agregar</button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="col-md-5">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Carrito</h5>
          <ul id="cartList" class="list-group mb-3"></ul>
          <div class="d-flex justify-content-between mb-3"><strong>Total</strong><strong id="cartTotal">S/ 0.00</strong></div>

          <form method="POST" action="{{ url_for('sell') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="items" id="itemsInput">
            <input type="hidden" name="total" id="totalInput">
            <div class="mb-2">
              <input name="client_name" placeholder="Nombre cliente (opcional)" class="form-control form-control-sm mb-1">
              <input name="client_doc" placeholder="Documento (opcional)" class="form-control form-control-sm mb-1">
              <textarea name="client_obs" placeholder="Observación (opcional)" class="form-control form-control-sm" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-success w-100">Registrar venta</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  const cart = [];
  function findInCart(pid){ return cart.find(i=>i.pid==pid); }
  function renderCart(){
    const list = document.getElementById('cartList'); list.innerHTML = '';
    let total = 0;
    cart.forEach((it, idx)=>{
      const li = document.createElement('li'); 
      li.className='list-group-item d-flex justify-content-between align-items-center anim-fade-in-up';
      li.innerHTML = `<div><strong>${it.nombre}</strong><div class="small">${it.qty} × S/ ${it.unit_price.toFixed(2)}</div></div><div><strong>S/ ${(it.qty*it.unit_price).toFixed(2)}</strong> <button class="btn btn-sm btn-link text-danger remove-item anim-icon-hover" data-idx="${idx}"><i class="bi bi-x-lg"></i></button></div>`;
      list.appendChild(li);
      total += it.qty*it.unit_price;
    });
    document.getElementById('cartTotal').textContent = 'S/ ' + total.toFixed(2);
    document.getElementById('itemsInput').value = JSON.stringify(cart.map(i=>({pid:i.pid, qty:i.qty, price:i.unit_price})));
    document.getElementById('totalInput').value = total.toFixed(2);
  }

  document.querySelectorAll('.add-item').forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.preventDefault();
      const pid = this.getAttribute('data-pid');
      const qtyEl = document.querySelector('.qty[data-pid="'+pid+'"]');
      const priceEl = document.querySelector('.price[data-pid="'+pid+'"]');
      const qty = Number(qtyEl.value) || 0;
      const price = Number(priceEl.value) || 0;
      
      // Validación con animación shake
      if (qty <= 0) { 
        qtyEl.classList.add('is-invalid', 'anim-shake-soft');
        setTimeout(() => qtyEl.classList.remove('anim-shake-soft'), 200);
        return; 
      }
      if (price < 0) { 
        priceEl.classList.add('is-invalid', 'anim-shake-soft');
        setTimeout(() => priceEl.classList.remove('anim-shake-soft'), 200);
        return; 
      }
      
      // Quitar estados de error
      qtyEl.classList.remove('is-invalid');
      priceEl.classList.remove('is-invalid');
      
      const nameEl = this.closest('.list-group-item').querySelector('strong');
      const existing = findInCart(Number(pid));
      if (existing){ existing.qty += qty; existing.unit_price = price; }
      else { cart.push({pid: Number(pid), nombre: nameEl.textContent.trim(), qty: qty, unit_price: price}); }
      
      // Feedback visual de éxito
      this.classList.add('anim-pulse-success');
      setTimeout(() => this.classList.remove('anim-pulse-success'), 300);
      
      qtyEl.value=''; priceEl.value=''; renderCart();
    });
  });

  document.getElementById('cartList').addEventListener('click', function(e){
    if (e.target.classList.contains('remove-item')){
      const idx = Number(e.target.getAttribute('data-idx'));
      cart.splice(idx,1); renderCart();
    }
  });

})();
</script>
</body>
</html>
