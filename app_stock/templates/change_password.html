<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Cambiar Contraseña</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link href="{{ url_for('static', filename='css/styles.css', v='4') }}" rel="stylesheet">
<style>
  .password-requirements {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
  }
  .password-requirements li {
    margin-bottom: 0.25rem;
  }
  .password-requirements li.valid {
    color: #28a745;
  }
  .password-requirements li.invalid {
    color: var(--text-secondary);
  }
  .password-strength {
    height: 4px;
    border-radius: 2px;
    margin-top: 0.5rem;
    background: var(--border);
    overflow: hidden;
  }
  .password-strength-bar {
    height: 100%;
    width: 0%;
    transition: width 0.3s, background-color 0.3s;
  }
  .password-strength-bar.weak { width: 33%; background: #dc3545; }
  .password-strength-bar.medium { width: 66%; background: #ffc107; }
  .password-strength-bar.strong { width: 100%; background: #28a745; }
  
  .warning-box {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }
  .warning-box i {
    color: #ffc107;
    font-size: 1.5rem;
    margin-right: 0.5rem;
  }
</style>
</head>
<body class="{{ user_theme }} d-flex justify-content-center align-items-center vh-100">

  <form method="POST" class="login-card text-center anim-fade-in-up" style="max-width: 420px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    
    <div class="brand-logo brand-logo--login">
      <img src="{{ url_for('static', filename='branding/logo_icon.png') }}" alt="China Import" 
           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
      <div class="brand-logo-fallback" style="display:none;font-size:1.5rem;font-weight:bold;color:var(--orange);">
        China Import
      </div>
    </div>
    
    <h4 class="mb-2"><i class="bi bi-key me-2"></i>Cambiar Contraseña</h4>
    
    {% if forced %}
    <div class="warning-box text-start d-flex align-items-start">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <div>
        <strong>Acción requerida</strong>
        <p class="mb-0 small">Por seguridad, debes establecer una nueva contraseña antes de acceder al sistema.</p>
      </div>
    </div>
    {% else %}
    <p class="form-help mb-3">Ingresa tu nueva contraseña</p>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <!-- toasts se renderizan abajo -->
      {% endif %}
    {% endwith %}

    <div class="text-start mb-3">
      <label class="form-label small text-muted">Nueva Contraseña</label>
      <div class="input-group">
        <input type="password" class="form-control" name="new_password" id="newPassword" 
               placeholder="Nueva contraseña" required minlength="8">
        <button class="btn btn-outline-secondary" type="button" id="togglePassword" tabindex="-1">
          <i class="bi bi-eye"></i>
        </button>
      </div>
      <div class="password-strength">
        <div class="password-strength-bar" id="strengthBar"></div>
      </div>
    </div>

    <div class="text-start mb-3">
      <label class="form-label small text-muted">Confirmar Contraseña</label>
      <input type="password" class="form-control" name="confirm_password" id="confirmPassword" 
             placeholder="Repetir contraseña" required minlength="8">
      <small class="text-danger" id="matchError" style="display: none;">
        <i class="bi bi-x-circle me-1"></i>Las contraseñas no coinciden
      </small>
    </div>

    <div class="text-start mb-3">
      <ul class="password-requirements list-unstyled mb-0">
        <li id="req-length"><i class="bi bi-circle me-1"></i>Mínimo 8 caracteres</li>
        <li id="req-upper"><i class="bi bi-circle me-1"></i>Al menos una mayúscula</li>
        <li id="req-lower"><i class="bi bi-circle me-1"></i>Al menos una minúscula</li>
        <li id="req-number"><i class="bi bi-circle me-1"></i>Al menos un número</li>
      </ul>
    </div>

    <button type="submit" class="btn btn-primary w-100 mb-2 btn-glow" id="submitBtn" disabled>
      <i class="bi bi-check-lg me-1"></i>Guardar Nueva Contraseña
    </button>

    {% if not forced %}
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary w-100">
      <i class="bi bi-arrow-left me-1"></i>Cancelar
    </a>
    {% endif %}
  </form>

  <!-- contenedor toasts -->
  <div id="toastContainer" class="toast-container-bottom" aria-live="polite" aria-atomic="true">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for cat, msg in messages %}
        {% if cat == 'success' %}
          {% set svg_path = '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' %}
          {% set title = 'Éxito' %}
        {% elif cat == 'warning' %}
          {% set svg_path = '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.29 3.86L1.82 18a1.99 1.99 0 0 0 1.71 3h16.94a1.99 1.99 0 0 0 1.72-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="0" fill="currentColor"/></svg>' %}
          {% set title = 'Atención' %}
        {% elif cat == 'danger' %}
          {% set svg_path = '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18.36 5.64L5.64 18.36M5.64 5.64l12.72 12.72" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' %}
          {% set title = 'Error' %}
        {% else %}
          {% set svg_path = '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/></svg>' %}
          {% set title = 'Notificación' %}
        {% endif %}

        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
          <div class="toast-header custom" style="color:var(--orange);">
            <span style="color:var(--orange);display:flex;align-items:center;">{{ svg_path | safe }}</span>
            <strong class="me-auto toast-title">{{ title }}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Cerrar"></button>
          </div>
          <div class="toast-body">{{ msg }}</div>
        </div>
      {% endfor %}
    {% endwith %}
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Toast initialization
  const toastContainer = document.getElementById('toastContainer');
  if (toastContainer) {
    const toastEls = toastContainer.querySelectorAll('.toast');
    toastEls.forEach(function(el){
      const t = new bootstrap.Toast(el);
      t.show();
    });
  }

  // Password validation
  const newPassword = document.getElementById('newPassword');
  const confirmPassword = document.getElementById('confirmPassword');
  const submitBtn = document.getElementById('submitBtn');
  const strengthBar = document.getElementById('strengthBar');
  const matchError = document.getElementById('matchError');
  const togglePassword = document.getElementById('togglePassword');

  // Requirements elements
  const reqLength = document.getElementById('req-length');
  const reqUpper = document.getElementById('req-upper');
  const reqLower = document.getElementById('req-lower');
  const reqNumber = document.getElementById('req-number');

  function updateRequirement(el, valid) {
    if (valid) {
      el.classList.add('valid');
      el.classList.remove('invalid');
      el.querySelector('i').className = 'bi bi-check-circle-fill me-1';
    } else {
      el.classList.remove('valid');
      el.classList.add('invalid');
      el.querySelector('i').className = 'bi bi-circle me-1';
    }
  }

  function validatePassword() {
    const pwd = newPassword.value;
    const confirm = confirmPassword.value;
    
    // Check requirements
    const hasLength = pwd.length >= 8;
    const hasUpper = /[A-Z]/.test(pwd);
    const hasLower = /[a-z]/.test(pwd);
    const hasNumber = /[0-9]/.test(pwd);
    
    updateRequirement(reqLength, hasLength);
    updateRequirement(reqUpper, hasUpper);
    updateRequirement(reqLower, hasLower);
    updateRequirement(reqNumber, hasNumber);
    
    // Calculate strength
    let strength = 0;
    if (hasLength) strength++;
    if (hasUpper && hasLower) strength++;
    if (hasNumber) strength++;
    if (pwd.length >= 12) strength++;
    if (/[!@#$%^&*(),.?":{}|<>]/.test(pwd)) strength++;
    
    // Update strength bar
    strengthBar.className = 'password-strength-bar';
    if (pwd.length > 0) {
      if (strength <= 2) strengthBar.classList.add('weak');
      else if (strength <= 3) strengthBar.classList.add('medium');
      else strengthBar.classList.add('strong');
    }
    
    // Check match
    const matches = pwd === confirm && confirm.length > 0;
    matchError.style.display = (confirm.length > 0 && !matches) ? 'block' : 'none';
    
    // Enable/disable submit
    const allValid = hasLength && hasUpper && hasLower && hasNumber && matches;
    submitBtn.disabled = !allValid;
  }

  newPassword.addEventListener('input', validatePassword);
  confirmPassword.addEventListener('input', validatePassword);

  // Toggle password visibility
  togglePassword.addEventListener('click', function() {
    const type = newPassword.type === 'password' ? 'text' : 'password';
    newPassword.type = type;
    confirmPassword.type = type;
    this.querySelector('i').className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
  });
});
</script>
</body>
</html>
